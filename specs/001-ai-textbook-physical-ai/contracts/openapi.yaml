openapi: 3.0.3
info:
  title: AI-Native Textbook API
  description: API for the Physical AI & Humanoid Robotics textbook application with security, observability, and scalability requirements
  version: 1.0.0
  contact:
    name: Textbook Development Team
    email: textbook@panaversity.org

servers:
  - url: https://api.textbook.panaversity.org
    description: Production server
  - url: https://staging-api.textbook.panaversity.org
    description: Staging server

paths:
  /auth/register:
    post:
      summary: Register a new user
      description: Creates a new user account with Better Auth integration and encrypted profile data
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserRegistration'
      responses:
        '201':
          description: User successfully registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
      security: []
      x-observability:
        - metrics: request_count, response_time
        - logging: user_action, security_event
      x-performance:
        target-response-time: "<500ms"

  /auth/login:
    post:
      summary: User login
      description: Authenticates user and returns encrypted session token
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserLogin'
      responses:
        '200':
          description: Successfully authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
      security: []
      x-observability:
        - metrics: request_count, response_time, auth_success_rate
        - logging: auth_attempt, auth_failure
      x-performance:
        target-response-time: "<500ms"

  /auth/logout:
    post:
      summary: User logout
      description: Invalidates the current user session
      tags:
        - Authentication
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Successfully logged out
        '401':
          $ref: '#/components/responses/Unauthorized'
      x-observability:
        - metrics: request_count, response_time
        - logging: user_action
      x-performance:
        target-response-time: "<500ms"

  /profile:
    get:
      summary: Get user profile
      description: Retrieves the current user's encrypted profile information
      tags:
        - Profile
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          $ref: '#/components/responses/Unauthorized'
      x-observability:
        - metrics: request_count, response_time
        - logging: user_action
      x-performance:
        target-response-time: "<500ms"
    put:
      summary: Update user profile
      description: Updates the current user's encrypted profile information
      tags:
        - Profile
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserProfileUpdate'
      responses:
        '200':
          description: User profile updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
      x-observability:
        - metrics: request_count, response_time
        - logging: user_action
      x-performance:
        target-response-time: "<500ms"

  /chapters:
    get:
      summary: List all textbook chapters
      description: Retrieves a list of all textbook chapters with basic information
      tags:
        - Chapters
      parameters:
        - name: module
          in: query
          required: false
          schema:
            type: string
            enum: [ros2, digital_twin, ai_robot_brain, vla]
          description: Filter chapters by module
        - name: week
          in: query
          required: false
          schema:
            type: integer
          description: Filter chapters by week number
      responses:
        '200':
          description: List of chapters retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  chapters:
                    type: array
                    items:
                      $ref: '#/components/schemas/ChapterSummary'
        '400':
          $ref: '#/components/responses/BadRequest'
      security: []
      x-observability:
        - metrics: request_count, response_time, cache_hit_rate
        - logging: user_action
      x-performance:
        target-response-time: "<1s"

  /chapters/{chapterId}:
    get:
      summary: Get chapter content
      description: Retrieves the full content of a specific chapter
      tags:
        - Chapters
      parameters:
        - name: chapterId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Unique identifier of the chapter
      responses:
        '200':
          description: Chapter content retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChapterDetail'
        '404':
          $ref: '#/components/responses/NotFound'
      security: []
      x-observability:
        - metrics: request_count, response_time, cache_hit_rate
        - logging: user_action
      x-performance:
        target-response-time: "<1s"

  /chapters/{chapterId}/translate:
    post:
      summary: Translate chapter to Urdu
      description: Translates the content of a chapter to Urdu with encrypted caching
      tags:
        - Translation
      security:
        - BearerAuth: []
      parameters:
        - name: chapterId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Unique identifier of the chapter
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                target_language:
                  type: string
                  default: ur
                  description: Target language code (currently only supports 'ur' for Urdu)
      responses:
        '200':
          description: Chapter translated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChapterTranslation'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
      x-observability:
        - metrics: request_count, response_time, cache_hit_rate
        - logging: user_action, translation_request
      x-performance:
        target-response-time: "<5s"

  /chapters/{chapterId}/personalize:
    post:
      summary: Get personalized chapter content
      description: Retrieves chapter content adjusted based on encrypted user profile
      tags:
        - Personalization
      security:
        - BearerAuth: []
      parameters:
        - name: chapterId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Unique identifier of the chapter
      responses:
        '200':
          description: Personalized chapter content retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChapterDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
      x-observability:
        - metrics: request_count, response_time
        - logging: user_action, personalization_request
      x-performance:
        target-response-time: "<2s"

  /chat/query:
    post:
      summary: Ask a question to the RAG chatbot
      description: Sends a question to the RAG system and gets a response based on textbook content
      tags:
        - Chat
      security:
        - BearerAuth: []  # Optional - anonymous queries allowed
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatQuery'
      responses:
        '200':
          description: Chat response generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '429':
          $ref: '#/components/responses/TooManyRequests'
      x-observability:
        - metrics: request_count, response_time, api_call_cost
        - logging: user_action, ai_interaction
      x-performance:
        target-response-time: "<500ms"

  /chat/query-selected:
    post:
      summary: Ask about selected text to the RAG chatbot
      description: Sends a question about specific selected text to the RAG system
      tags:
        - Chat
      security:
        - BearerAuth: []  # Optional - anonymous queries allowed
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SelectedTextQuery'
      responses:
        '200':
          description: Chat response generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '429':
          $ref: '#/components/responses/TooManyRequests'
      x-observability:
        - metrics: request_count, response_time, api_call_cost
        - logging: user_action, ai_interaction
      x-performance:
        target-response-time: "<500ms"

  /health:
    get:
      summary: Health check
      description: System health check with performance and availability metrics
      tags:
        - Health
      responses:
        '200':
          description: System is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
      security: []
      x-observability:
        - metrics: health_status, uptime, response_time
        - logging: system_status
      x-scalability:
        concurrent-users: "1000+"
        availability: "99.9%"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    UserRegistration:
      type: object
      required:
        - email
        - password
        - name
      properties:
        email:
          type: string
          format: email
          description: User's email address (encrypted at rest)
        password:
          type: string
          format: password
          minLength: 8
          description: User's password
        name:
          type: string
          minLength: 2
          maxLength: 100
          description: User's full name (encrypted at rest)
        profile_data:
          $ref: '#/components/schemas/UserProfile'

    UserLogin:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: User's email address
        password:
          type: string
          format: password
          description: User's password

    LoginResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT token for authentication
        user:
          $ref: '#/components/schemas/UserResponse'

    UserResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique user identifier
        email:
          type: string
          format: email
          description: User's email address
        name:
          type: string
          description: User's full name
        created_at:
          type: string
          format: date-time
          description: Account creation timestamp

    UserProfile:
      type: object
      properties:
        programming_experience:
          type: string
          enum: [beginner, intermediate, advanced]
          description: User's programming skill level
        robotics_background:
          type: string
          enum: [none, basic, intermediate, expert]
          description: User's robotics experience
        hardware_access:
          type: object
          properties:
            gpu_capability:
              type: string
              enum: [none, basic, mid, high]
            robot_access:
              type: string
              enum: [none, simulation_only, physical_robot]
            development_environment:
              type: string
              enum: [windows, macos, linux]
        preferred_language:
          type: string
          enum: [en, ur]
          default: en
          description: Default content language preference
        learning_goals:
          type: string
          description: User's specific learning objectives
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    UserProfileUpdate:
      type: object
      properties:
        programming_experience:
          type: string
          enum: [beginner, intermediate, advanced]
        robotics_background:
          type: string
          enum: [none, basic, intermediate, expert]
        hardware_access:
          type: object
          properties:
            gpu_capability:
              type: string
              enum: [none, basic, mid, high]
            robot_access:
              type: string
              enum: [none, simulation_only, physical_robot]
            development_environment:
              type: string
              enum: [windows, macos, linux]
        preferred_language:
          type: string
          enum: [en, ur]
        learning_goals:
          type: string

    ChapterSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique chapter identifier
        title:
          type: string
          description: Chapter title
        slug:
          type: string
          description: URL-friendly identifier
        module:
          type: string
          enum: [ros2, digital_twin, ai_robot_brain, vla]
          description: Module the chapter belongs to
        week_number:
          type: integer
          description: Week number in the course (1-13)
        created_at:
          type: string
          format: date-time

    ChapterDetail:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        slug:
          type: string
        module:
          type: string
          enum: [ros2, digital_twin, ai_robot_brain, vla]
        week_number:
          type: integer
        content:
          type: string
          description: Markdown content of the chapter
        learning_objectives:
          type: array
          items:
            type: string
        prerequisites:
          type: array
          items:
            type: string
        exercises:
          type: array
          items:
            type: object
        review_questions:
          type: array
          items:
            type: object
        further_reading:
          type: array
          items:
            type: object
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ChapterTranslation:
      type: object
      properties:
        original_chapter_id:
          type: string
          format: uuid
        target_language:
          type: string
          description: Target language code
        translated_content:
          type: string
          description: Translated chapter content in Markdown
        created_at:
          type: string
          format: date-time

    ChatQuery:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          description: The user's question
          minLength: 5
          maxLength: 2000

    SelectedTextQuery:
      type: object
      required:
        - query
        - selected_text
      properties:
        query:
          type: string
          description: The user's question about the selected text
          minLength: 5
          maxLength: 2000
        selected_text:
          type: string
          description: The text that was selected by the user
          maxLength: 5000

    ChatResponse:
      type: object
      properties:
        query_id:
          type: string
          format: uuid
          description: Unique identifier for the query
        response:
          type: string
          description: The chatbot's response
        confidence_score:
          type: number
          minimum: 0
          maximum: 1
          description: Confidence score for the response
        source_documents:
          type: array
          items:
            type: object
            properties:
              title:
                type: string
              chapter_id:
                type: string
                format: uuid
              relevance_score:
                type: number
        created_at:
          type: string
          format: date-time

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unavailable]
          description: Overall system health status
        timestamp:
          type: string
          format: date-time
          description: Time of the health check
        services:
          type: object
          additionalProperties:
            type: string
            description: Status of individual services
        metrics:
          type: object
          properties:
            uptime:
              type: string
              description: System uptime
            response_time:
              type: number
              description: Average response time in ms
            concurrent_users:
              type: integer
              description: Current number of concurrent users

  responses:
    BadRequest:
      description: Invalid request parameters or body
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: "Invalid request parameters"
              details:
                type: object
      x-observability:
        - logging: error_details
    Unauthorized:
      description: Authentication required or invalid
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: "Authentication required"
      x-observability:
        - logging: security_event
    NotFound:
      description: Requested resource not found
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: "Resource not found"
      x-observability:
        - logging: error_details
    Conflict:
      description: Resource conflict (e.g., duplicate email)
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: "Email already exists"
      x-observability:
        - logging: error_details
    TooManyRequests:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: "Rate limit exceeded, please try again later"
      x-observability:
        - logging: rate_limit_event